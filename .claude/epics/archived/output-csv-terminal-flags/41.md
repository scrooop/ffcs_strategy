---
name: Refactor CSV Schema to v3.0 (Eliminate atm_* Columns)
status: completed
created: 2025-10-20T17:48:36Z
updated: 2025-10-20T19:58:30Z
completed: 2025-10-20T18:52:00Z
github: https://github.com/scrooop/ffcs_strategy/issues/41
depends_on: []
parallel: true
conflicts_with: [42]
---

# Task: Refactor CSV Schema to v3.0 (Eliminate atm_* Columns)

## Description

Eliminate redundant `atm_*` column namespace, use unified columns for both ATM and double calendar structures. Reduce CSV from 40 → 32 columns (20% reduction), eliminate 16 empty columns per row.

**Priority:** MEDIUM (Phase 3 - CSV Schema Refactor)

**Breaking Change:** CSV schema v3.0 incompatible with v2.2 parsers

## Acceptance Criteria

- [ ] `CSV_COLUMNS` list updated (40 → 32 columns)
- [ ] 8 `atm_*` columns removed: `atm_strike`, `atm_delta`, `atm_ff`, `atm_iv_front`, `atm_iv_back`, `atm_fwd_iv`, `atm_iv_source_front`, `atm_iv_source_back`
- [ ] 3 columns renamed: `call_strike` → `strike`, `call_delta` → `delta`, `call_ff` → `ff`
- [ ] ATM row population logic updated (populate `strike`, `delta`, `ff`, `min_ff`)
- [ ] Double row population logic updated (populate `strike`, `put_strike`, `delta`, `put_delta`, `ff`, `put_ff`, `min_ff`, `combined_ff`)
- [ ] CSV sorting still works correctly (by `ff` for ATM, by `min_ff` for double)
- [ ] Version comment updated to v3.0 in file header

## Technical Details

### Files to Modify
- `scripts/ff_tastytrade_scanner.py`:
  - Update CSV_COLUMNS list (around line 1851-1875)
  - Update ATM row population (around line 1560-1600)
  - Update double row population (around line 1350-1400)
  - Update sorting logic (around line 1600-1615)
  - Update version comment in file header (line 1-10)

### Implementation Approach

**1. Update CSV_COLUMNS List (32 columns):**
```python
CSV_COLUMNS = [
    # Metadata (4)
    "timestamp", "symbol", "structure", "spot_price",
    # Expirations (4)
    "front_dte", "back_dte", "front_expiry", "back_expiry",
    # Strikes/Deltas (4) - UNIFIED NAMESPACE
    "strike", "put_strike", "delta", "put_delta",
    # FF Metrics (4)
    "ff", "put_ff", "min_ff", "combined_ff",
    # IV Detail (6)
    "call_front_iv", "call_back_iv", "call_fwd_iv",
    "put_front_iv", "put_back_iv", "put_fwd_iv",
    # IV Sources (4)
    "iv_source_call_front", "iv_source_call_back",
    "iv_source_put_front", "iv_source_put_back",
    # Quality Filters (6)
    "earnings_conflict", "earnings_date", "option_volume_today",
    "liq_rating", "earnings_source", "skip_reason"
]
```

**2. Update ATM Row Population:**
```python
# ATM calendar row (around line 1560)
row = {
    "timestamp": datetime.now(UTC).isoformat(),
    "symbol": sym,
    "structure": "atm-call",
    "spot_price": spot,
    "front_dte": front_dte,
    "back_dte": back_dte,
    "front_expiry": front_choice.expiration.isoformat(),
    "back_expiry": back_choice.expiration.isoformat(),
    # UNIFIED COLUMNS (NEW)
    "strike": f"{front_choice.strike:.2f}",
    "delta": round(front_choice.actual_delta, 4),
    "ff": round(atm_ff, 6),
    "min_ff": round(atm_ff, 6),  # Same as ff for ATM
    # EMPTY FOR ATM
    "put_strike": "",
    "put_delta": "",
    "put_ff": "",
    "combined_ff": "",
    # IV Detail (existing)
    "call_front_iv": round(call_iv_f, 6),
    "call_back_iv": round(call_iv_b, 6),
    "call_fwd_iv": round(call_fwd_iv, 6),
    "put_front_iv": round(put_iv_f, 6),
    "put_back_iv": round(put_iv_b, 6),
    "put_fwd_iv": round(put_fwd_iv, 6),
    # IV Sources (unified tracking)
    "iv_source_call_front": iv_src_call_f,
    "iv_source_call_back": iv_src_call_b,
    "iv_source_put_front": iv_src_put_f,
    "iv_source_put_back": iv_src_put_b,
    # Quality Filters (existing)
    "earnings_conflict": earnings_conflict,
    "earnings_date": earnings_date.isoformat() if earnings_date else "",
    "option_volume_today": option_volume if option_volume else "",
    "liq_rating": liq_rating if liq_rating else "",
    "earnings_source": earnings_source,
    "skip_reason": ""
}
```

**3. Update Double Row Population:**
```python
# Double calendar row (around line 1350)
row = {
    # ... same metadata/expirations as ATM ...
    # UNIFIED COLUMNS (RENAMED)
    "strike": f"{call_strike:.2f}",          # RENAMED from call_strike
    "put_strike": f"{put_strike:.2f}",       # UNCHANGED
    "delta": round(call_delta, 4),           # RENAMED from call_delta
    "put_delta": round(put_delta, 4),        # UNCHANGED
    "ff": round(call_ff, 6),                 # RENAMED from call_ff
    "put_ff": round(put_ff, 6),              # UNCHANGED
    "min_ff": round(min(call_ff, put_ff), 6),  # UNCHANGED
    "combined_ff": round((call_ff + put_ff)/2, 6),  # UNCHANGED
    # ... rest same as ATM ...
}
```

**4. Update Sorting Logic:**
```python
# Sort ATM calendars by 'ff' (was 'atm_ff')
atm_rows.sort(key=lambda r: (-r["ff"], r["symbol"]))

# Sort double calendars by 'min_ff' (UNCHANGED)
doubles.sort(key=lambda r: (-r["min_ff"], -r["combined_ff"], r["symbol"]))
```

**5. Update Version Comment:**
```python
# At top of file (line 3-5)
# ff_tastytrade_scanner.py
# Forward Factor Scanner v3.0 (CSV schema refactor)
# ...
```

### Key Considerations
- Breaking change: existing CSV parsers will fail on v3.0
- Empty columns for ATM: `put_strike`, `put_delta`, `put_ff`, `combined_ff`
- Empty columns for double: none (all populated)
- Column order unchanged (will be updated in Task #42)
- Maintain backward compatibility within code (use unified column names)

## Dependencies

**Internal:**
- [ ] Conflicts with Task #42 (same code sections for CSV columns)

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 6-8 hours
- **Parallel:** false (conflicts with task 42)

### Breakdown:
- Update CSV_COLUMNS list: 1 hour
- Update ATM row population logic: 2-3 hours
- Update double row population logic: 2-3 hours
- Update sorting logic & testing: 1-2 hours

## Definition of Done

- [ ] CSV_COLUMNS list has exactly 32 columns
- [ ] 8 `atm_*` columns removed from list
- [ ] 3 columns renamed in CSV_COLUMNS list
- [ ] ATM rows populate unified columns correctly
- [ ] Double rows populate unified columns correctly
- [ ] CSV sorting works (ATM by `ff`, double by `min_ff`)
- [ ] Test scan produces valid v3.0 CSV
- [ ] CSV header matches new column list exactly
- [ ] Version updated to v3.0 in file header
