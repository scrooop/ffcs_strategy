---
name: Update Double Calendar Gating (Min-Gate)
status: completed
created: 2025-10-20T04:35:49Z
updated: 2025-10-20T11:25:00Z
completed: 2025-10-20T11:25:00Z
github: https://github.com/scrooop/ffcs_strategy/issues/26
depends_on: [23, 25]
parallel: true
conflicts_with: [24]
---

# Task 005: Update Double Calendar Gating (Min-Gate)

## Description

Change double calendar gating from average(FF_call, FF_put) to min(FF_call, FF_put). Both wings must independently meet threshold. Add min_ff column as primary sorting metric.

## Acceptance Criteria

- [x] Add `min_ff = min(call_ff, put_ff)` computation for double structure
- [x] Change gating logic: `min_ff >= threshold` (was `combined_ff >= threshold`)
- [x] Retain `combined_ff = avg(call_ff, put_ff)` for reference only
- [x] Update CSV columns: add min_ff, keep combined_ff
- [x] Update sorting logic: doubles sort by min_ff descending (primary), combined_ff secondary
- [x] Verify both wings must pass threshold independently
- [x] Add unit tests for min-gate filtering logic

## Technical Details

- **File:** scripts/ff_tastytrade_scanner.py
- **Scan loop:** Double structure branch (lines 1104-1220)
- **Per-wing FF calculation:** Unchanged (already correct)
- **Gating logic change:** min_ff_double >= min_ff (was combined_ff >= min_ff)

## Implementation Summary

**Changes Made:**
1. Added min_ff_double = min(call_ff, put_ff) calculation (lines 1108, 1185)
2. Updated gating logic to use min_ff_double >= min_ff (line 1191)
3. Added min_ff column to CSV schema (line 1623) - now 32 columns
4. Added min_ff to row dictionaries (lines 1200, 1378)
5. Updated sorting: doubles by min_ff desc (primary), combined_ff desc (secondary) (lines 1406-1420)
6. Added 10 unit tests for min-gate filtering logic (tests/test_ff_calculations.py:812-998)

**Test Results:**
- All 52 tests passing (13 relevant to this task)
- Min-gate tests cover: basic calculation, edge cases, filtering scenarios
- Verified min-gate is more conservative than average-gate

**Commits:**
- 2fe6c0b: feat(tests): Add unit tests for min-gate filtering logic (Issue #26)
- e3f6f3b: feat(scanner): Implement min-gate filtering for double calendars (Issue #26)

## Dependencies

- Task 001, 002 (validation and skip tracking) âœ… Complete
- Independent of Task 003-004 (different structure)

## Effort Estimate

- **Size:** S
- **Hours:** 3-4 (actual: ~3.5 hours)
- **Parallel:** true (can run with Tasks 006-007)

## Definition of Done

- [x] min_ff calculation added
- [x] Gating logic updated to use min_ff
- [x] CSV columns updated
- [x] Sorting by min_ff working
- [x] Unit tests passing
