---
name: Invert IV Source Priority (Greeks Primary)
status: open
created: 2025-10-19T23:37:22Z
updated: 2025-10-20T04:47:03Z
github: https://github.com/scrooop/ffcs_strategy/issues/29
depends_on: [23, 25]
parallel: true
conflicts_with: [24]
---

# Task 006: Invert IV Source Priority (Greeks Primary)

## Description

CRITICAL DECISION: Invert IV source priority to use strike-level Greeks IV as primary (preserves wing skew), with expiration-level ex-earn IV as rare fallback only. Remove confusing CLI flags.

## Acceptance Criteria

- [ ] Change IV priority: Greeks IV (primary) → ex-earn IV (fallback if Greeks missing/timeout)
- [ ] Remove `--use-xearn-iv` and `--force-greeks-iv` CLI flags (no longer needed)
- [ ] Update `iv_source` tracking: "greeks" (primary) or "exearn_fallback" (rare)
- [ ] For ATM: Use Greeks IV from 50Δ strike, fallback to ex-earn if missing
- [ ] For doubles: Use Greeks IV from ±35Δ strikes (wing-specific), fallback to ex-earn
- [ ] Update all IV source columns in CSV output
- [ ] Document: Ex-earn IV is expiration-level (collapses skew), Greeks IV is strike-level (preserves skew)
- [ ] Add logging when fallback to ex-earn is used

## Technical Details

**File:** `scripts/ff_tastytrade_scanner.py`

**Changes Required:**
- Modify IV extraction logic in scan loop
- Greeks IV already fetched from `snapshot_greeks()` (strike-specific)
- Ex-earn IV from `extract_xearn_iv()` (expiration-level, less accurate for wings)
- Rationale: Wing-exact FF requires strike-specific IV

**Key Implementation Points:**
1. Primary path: Use Greeks IV from dxFeed snapshot (strike-level precision)
2. Fallback path: Use ex-earn IV only when Greeks data missing/timeout
3. Track source in CSV columns: `iv_source_call_front`, `iv_source_call_back`, `iv_source_put_front`, `iv_source_put_back`
4. Remove CLI complexity: No more user choice between IV sources

## Dependencies

- **Task 001:** Validation framework (verify Greeks IV quality)
- **Task 002:** Skip tracking (log when ex-earn fallback used)
- **Independent of:** ATM/double changes (Tasks 003-005)

## Effort Estimate

- **Size:** M
- **Hours:** 4-5
- **Parallel:** true (can run with Tasks 003-005)

## Definition of Done

- [ ] IV priority inverted (Greeks primary, ex-earn fallback)
- [ ] CLI flags `--use-xearn-iv` and `--force-greeks-iv` removed
- [ ] `iv_source` columns updated to reflect new logic
- [ ] Fallback logging added (warn when ex-earn used)
- [ ] Documentation updated with rationale (strike-level vs expiration-level IV)
- [ ] Integration tests verify Greeks used by default
- [ ] Edge cases tested: Greeks timeout, ex-earn missing, both missing

## Notes

**Why This Matters:**
- Ex-earn IV is expiration-level (single value per expiration, collapses skew)
- Greeks IV is strike-level (preserves volatility smile/skew)
- For double calendars, ±35Δ strikes may have 5-10% IV difference vs ATM
- Using ex-earn for wings loses critical pricing information
- Greeks IV should be primary; ex-earn is rare fallback only

**Breaking Change:**
- CLI flags removed (simpler interface)
- Default behavior changes (was ex-earn primary, now Greeks primary)
- Update documentation to reflect new priority
