---
name: Implement Volume-Based Liquidity Filter
status: open
created: 2025-10-19T23:37:22Z
updated: 2025-10-20T04:47:03Z
github: https://github.com/scrooop/ffcs_strategy/issues/32
depends_on: [25]
parallel: true
conflicts_with: [24]
---

# Task 007: Implement Volume-Based Liquidity Filter

## Description

Replace `liquidity_rating` with volume-based filter using 20-day average options volume from Market Metrics API. Enforce strategy's "≥10k avg options volume/day" rule.

## Acceptance Criteria

- [ ] Add volume extraction to `fetch_market_metrics()` function
- [ ] Extract `avg_options_volume_20d` field from API response
- [ ] Implement filter: skip symbols with volume < threshold (default 10000)
- [ ] Add `--min-avg-volume` CLI flag (default: 10000, configurable)
- [ ] Keep `--skip-liquidity-check` flag to disable volume filtering (for testing)
- [ ] Remove ALL references to `liquidity_rating` from code
- [ ] Add `avg_options_volume_20d` column to CSV output
- [ ] Use `skip_reason = "volume_too_low"` when filtering
- [ ] Batch fetch volume data for all symbols (leverage existing batch logic)

## Technical Details

**File:** `scripts/ff_tastytrade_scanner.py`

**Function:** `fetch_market_metrics()` (already batches earnings data)

**API:** tastytrade Market Metrics API

**Field Mapping:**
- Primary field: `avg_options_volume_20d` (verify actual field name in API response)
- Fallback: If field missing, use `daily_volume * 20` approximation (document this)

**Implementation Approach:**
1. Leverage existing batch fetch in `fetch_market_metrics()`
2. Extract volume field alongside earnings data
3. Store in `market_metrics` dict: `{symbol: {'avg_options_volume': value}}`
4. Filter before expensive Greeks fetching (pre-filter optimization)
5. Track filtered symbols with `skip_reason = "volume_too_low"`

## Dependencies

- **Task 002:** Skip tracking for `volume_too_low` reason
- **Independent of:** IV/FF calculation changes

## Effort Estimate

- **Size:** M
- **Hours:** 4-5
- **Parallel:** true (can run with Tasks 003-006)

## Definition of Done

- [ ] Volume extraction implemented in `fetch_market_metrics()`
- [ ] Filter logic working with threshold check
- [ ] `--min-avg-volume` CLI flag added and tested
- [ ] `liquidity_rating` fully removed from codebase (code + docs)
- [ ] `avg_options_volume_20d` column added to CSV output
- [ ] Batch fetching tested (verify no performance regression)
- [ ] Fallback documented if API field missing
- [ ] Edge cases tested: field missing, zero volume, futures (futures may not have volume field)

## Notes

**Strategy Requirement:**
- Per CLAUDE.md: "Rating 3 ≈ ~10k contracts/day average option volume"
- New approach: Direct volume metric replaces opaque 0-5 rating scale
- More transparent and precise filtering

**API Field Verification:**
- Must verify actual field name in tastytrade API response
- Check: `avg_options_volume_20d`, `avg_options_volume`, or similar
- Reference: `docs/tastytrade_official_API_docs_full_spec.json`
- If field doesn't exist, use `daily_volume * 20` approximation

**Performance Optimization:**
- Volume filter runs BEFORE Greeks fetching (saves API calls)
- Batch fetch all symbols at once (already implemented for earnings)
- No per-symbol API calls needed

**Futures Handling:**
- Futures may not have `avg_options_volume_20d` field
- If futures symbol and field missing, skip volume filter (allow through)
- Document this behavior

**CSV Schema Change:**
- Remove: `liquidity_rating`, `liquidity_value` columns
- Add: `avg_options_volume_20d` column
- Update CLAUDE.md schema documentation (31 columns → updated count)

**Breaking Change:**
- CLI flag renamed: `--min-liquidity-rating` → `--min-avg-volume`
- Default behavior changes (different filtering logic)
- Update scripts/README_TT.md examples
