---
name: Create earnings_cache.py module with SQLite backend and Yahoo Finance integration
status: open
created: 2025-10-19T23:56:22Z
updated: 2025-10-20T00:06:54Z
github: https://github.com/scrooop/ffcs_strategy/issues/15
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Create earnings_cache.py module with SQLite backend and Yahoo Finance integration

## Description

Create a standalone `scripts/earnings_cache.py` module that provides persistent caching of earnings dates using SQLite, with Yahoo Finance as the primary data source. This module will be the foundation for fast earnings pre-filtering, replacing slow TastyTrade API calls.

**Key responsibilities:**
- SQLite database management (create schema, CRUD operations)
- Yahoo Finance earnings date fetching via yfinance
- Cache invalidation logic (re-fetch when date in past)
- Batch processing for multiple symbols

## Acceptance Criteria

- [ ] `scripts/earnings_cache.py` file created with `EarningsCache` class
- [ ] SQLite database schema implemented with table: `earnings(symbol, next_earnings_date, last_updated, data_source)`
- [ ] `__init__()` method creates `.cache/earnings.db` if doesn't exist
- [ ] `get_next_earnings(symbol)` method returns dict with earnings date or None
- [ ] `batch_get_earnings(symbols)` method processes multiple symbols efficiently
- [ ] Cache invalidation: if `next_earnings_date < today()`, re-fetch from Yahoo Finance
- [ ] Yahoo Finance integration using yfinance library (ticker.calendar or get_earnings_dates())
- [ ] Futures symbols (starting with '/') automatically return None (no earnings)
- [ ] Module-level docstring explaining architecture and usage
- [ ] All public methods have comprehensive docstrings with examples

## Technical Details

**File location:** `scripts/earnings_cache.py`

**Class structure:**
```python
class EarningsCache:
    """Persistent earnings date cache with Yahoo Finance fetching."""

    def __init__(self, cache_path: str = ".cache/earnings.db"):
        """Initialize cache, create DB if doesn't exist."""

    def get_next_earnings(self, symbol: str) -> dict:
        """
        Get next earnings date for symbol.

        Returns:
            {
                "symbol": "AAPL",
                "next_earnings": "2025-11-01",  # YYYY-MM-DD or None
                "source": "cache" | "yahoo",
                "cached_at": "2025-10-19T23:56:22Z"
            }
        """

    def batch_get_earnings(self, symbols: list[str]) -> dict[str, dict]:
        """Batch fetch earnings for multiple symbols (optimized)."""

    def _fetch_from_yahoo(self, symbol: str) -> Optional[date]:
        """Fetch next earnings date from Yahoo Finance via yfinance."""

    def _is_cache_fresh(self, earnings_date: date) -> bool:
        """Check if cached earnings date is still in the future."""
```

**SQLite schema:**
```sql
CREATE TABLE IF NOT EXISTS earnings (
    symbol TEXT PRIMARY KEY,
    next_earnings_date TEXT,  -- YYYY-MM-DD format or NULL
    last_updated TEXT,         -- ISO timestamp
    data_source TEXT           -- 'cache' | 'yahoo'
)
```

**Yahoo Finance integration:**
- Use yfinance library (already installed)
- Try `ticker.calendar` first, fallback to `ticker.get_earnings_dates()`
- Extract next upcoming earnings date from returned data
- Handle API failures gracefully (return None, log warning)

**Cache invalidation logic:**
```python
if cached_date is None:
    fetch_from_yahoo()
elif cached_date < today():
    # Date has passed, fetch next earnings
    fetch_from_yahoo()
else:
    # Use cached value
    return cached_date
```

**Files affected:**
- `scripts/earnings_cache.py` (NEW)
- `.cache/` directory (created if doesn't exist)
- `.cache/earnings.db` (created at runtime)

## Dependencies

- [ ] Python stdlib: `sqlite3`, `datetime`
- [ ] External: `yfinance` (already installed)
- [ ] No blocking dependencies (can start immediately)

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 8-12 hours
- **Parallel:** true (independent of other tasks)

**Breakdown:**
- SQLite schema + CRUD operations: 3-4 hours
- Yahoo Finance integration: 2-3 hours
- Cache invalidation logic: 1-2 hours
- Futures symbol handling: 1 hour
- Docstrings and code cleanup: 1-2 hours

## Definition of Done

- [ ] Code implemented and follows Python best practices
- [ ] Manual testing: Verify cache hits/misses work correctly
- [ ] Manual testing: Verify Yahoo Finance fetching works for 10+ symbols
- [ ] Manual testing: Verify futures symbols return None immediately
- [ ] Manual testing: Verify cache invalidation (change system date or use old cached date)
- [ ] Docstrings complete with usage examples
- [ ] Code reviewed (self-review for edge cases)
- [ ] Ready for integration testing (Task 002)

## Testing Notes

**Manual testing checklist:**
1. First run: All cache misses, fetch from Yahoo Finance
2. Second run: All cache hits (instant lookup)
3. Change cached date to past: Re-fetch from Yahoo Finance
4. Test with futures symbols (/ES, /GC): Return None without API call
5. Test with invalid symbols: Graceful error handling
6. Test batch_get_earnings() with 100 symbols: Performance check (<10s target)

**Edge cases to handle:**
- Yahoo Finance API timeout or error
- Symbol not found on Yahoo Finance
- Earnings date not available (company doesn't report)
- SQLite database locked (concurrent access)
- Corrupted cache database

## Notes

**No TastyTrade integration yet:** This task focuses on Yahoo Finance only. TastyTrade fallback will be added in Task 003.

**Performance target:** `batch_get_earnings()` should handle 1000 symbols in <10 seconds (cache hits <1s, cold start <30s).

**Cache location:** `.cache/earnings.db` in project root (not in scripts/ to keep data separate from code).
