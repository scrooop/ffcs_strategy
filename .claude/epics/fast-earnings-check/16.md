---
name: Integrate earnings pre-filter into scanner pipeline
status: open
created: 2025-10-19T23:56:22Z
updated: 2025-10-20T00:07:01Z
github: https://github.com/scrooop/ffcs_strategy/issues/16
depends_on: [15]
parallel: false
conflicts_with: []
---

# Task: Integrate earnings pre-filter into scanner pipeline

## Description

Integrate the `EarningsCache` module into the main scanner pipeline (`ff_tastytrade_scanner.py`) to filter symbols by earnings conflicts BEFORE any TastyTrade API calls. This is the core performance optimization that eliminates 80%+ of symbols in under 10 seconds.

**Key changes:**
- Import and instantiate `EarningsCache` in `main()`
- Call `batch_get_earnings()` before TastyTrade processing
- Filter symbols using existing `check_earnings_conflict()` logic
- Add console logging (cache stats, timing, filtered symbols)
- Only pass filtered symbols to existing TastyTrade pipeline

## Acceptance Criteria

- [ ] `EarningsCache` imported and instantiated in `main()` function
- [ ] Earnings pre-filter runs BEFORE `fetch_market_metrics()` call
- [ ] Symbols with earnings conflicts are filtered out (unless `--allow-earnings` flag set)
- [ ] Console output shows: "Earnings pre-filter: {total} → {passed} passed ({filtered} filtered)"
- [ ] Cache statistics logged: "Cache hits: {hits} | Fresh fetches: {misses}"
- [ ] Earnings check timing logged: "Earnings check completed in {seconds}s"
- [ ] `--show-earnings-conflicts` flag shows filtered symbols with reasons
- [ ] `--allow-earnings` flag bypasses earnings pre-filter entirely
- [ ] Futures symbols automatically pass earnings filter (no API call)
- [ ] Only passing symbols proceed to TastyTrade API calls

## Technical Details

**File location:** `scripts/ff_tastytrade_scanner.py`

**Integration point:** Early in `main()`, after argparse but before TastyTrade processing

**Pseudo-code:**
```python
def main():
    # ... parse args, authenticate session ...

    # NEW: Early earnings pre-filter
    if not args.allow_earnings:
        import time
        start_time = time.time()

        # Initialize cache
        from earnings_cache import EarningsCache
        cache = EarningsCache()

        # Batch fetch earnings
        earnings_data = cache.batch_get_earnings(tickers)

        # Count cache hits/misses
        cache_hits = sum(1 for d in earnings_data.values() if d['source'] == 'cache')
        fresh_fetches = len(earnings_data) - cache_hits

        # Filter symbols using existing check_earnings_conflict() logic
        passing_symbols = []
        filtered_symbols = []
        for symbol in tickers:
            # Determine back expiry for earnings conflict check
            back_dte = max(pair[1] for pair in dte_pairs)  # Use furthest back DTE
            back_expiry = ny_today() + timedelta(days=back_dte)

            # Check earnings conflict
            next_earnings = earnings_data[symbol]["next_earnings"]
            if next_earnings:
                earnings_date = date.fromisoformat(next_earnings)
                if ny_today() <= earnings_date <= back_expiry:
                    reason = f"Earnings on {next_earnings} conflicts with back expiry {back_expiry}"
                    filtered_symbols.append((symbol, reason))
                    continue

            passing_symbols.append(symbol)

        # Log results
        elapsed = time.time() - start_time
        print(f"Earnings pre-filter: {len(tickers)} → {len(passing_symbols)} passed ({len(filtered_symbols)} filtered)")
        print(f"  Cache hits: {cache_hits} | Fresh fetches: {fresh_fetches}")
        print(f"  Earnings check completed in {elapsed:.1f}s")

        if args.show_earnings_conflicts:
            for symbol, reason in filtered_symbols:
                print(f"  {symbol}: {reason}")

        # Only process passing symbols
        tickers = passing_symbols

    # EXISTING: Continue with TastyTrade pipeline (unchanged)
    market_metrics = fetch_market_metrics(session, tickers)  # Now only for passing symbols
    # ... rest of pipeline ...
```

**Key considerations:**
- Reuse existing `check_earnings_conflict()` logic where possible
- Determine `back_expiry` from DTE pairs (use max back DTE for conservative filtering)
- Handle edge case: if `--allow-earnings` set, skip entire pre-filter block
- Preserve existing behavior for `--show-earnings-conflicts` flag

**Files affected:**
- `scripts/ff_tastytrade_scanner.py` (modified main() function)

## Dependencies

- [ ] Task 001 must be completed (EarningsCache module exists)
- [ ] Existing scanner functions: `check_earnings_conflict()`, `fetch_market_metrics()`

## Effort Estimate

- **Size:** S (Small)
- **Hours:** 4-6 hours
- **Parallel:** false (depends on Task 001)

**Breakdown:**
- Import and instantiate EarningsCache: 1 hour
- Implement filtering logic: 2-3 hours
- Add console logging: 1 hour
- Integration testing: 1-2 hours

## Definition of Done

- [ ] Code implemented and integrated into main()
- [ ] Manual testing: Run scanner with 10 symbols, verify pre-filter works
- [ ] Manual testing: Run with --allow-earnings, verify pre-filter skipped
- [ ] Manual testing: Run with --show-earnings-conflicts, verify filtered symbols shown
- [ ] Performance testing: Verify earnings check completes in <5s for 100 symbols
- [ ] Backward compatibility: Verify scanner produces same results as before (just faster)
- [ ] Code reviewed (check for edge cases)

## Testing Notes

**Manual testing checklist:**
1. Run scanner with 10 symbols during earnings week: Verify most filtered
2. Run scanner with --allow-earnings: Verify all symbols processed
3. Run scanner with --show-earnings-conflicts: Verify filtered symbols listed
4. Run scanner with futures symbols (/ES, /GC): Verify instant pass (no API call)
5. Performance test: 100 symbols, measure earnings check time (target <5s)

**Backward compatibility test:**
Run same symbol list with and without pre-filter (mock Yahoo to return same data as TastyTrade):
- Verify same symbols filtered
- Verify same CSV output (except timing)

**Edge cases:**
- Empty ticker list
- All symbols have earnings conflicts (100% filtered)
- No symbols have earnings conflicts (0% filtered)
- Mixed equities and futures

## Notes

**TastyTrade still used for liquidity:** The pre-filter only handles earnings. Liquidity screening still happens via `fetch_market_metrics()` in the existing pipeline (for passing symbols only).

**Performance optimization:** By filtering upfront, we avoid ~500ms TastyTrade API calls for 80%+ of symbols during earnings weeks.

**No CSV changes yet:** Earnings source tracking (Task 004) will add the `earnings_source` column. This task focuses on functional integration only.
