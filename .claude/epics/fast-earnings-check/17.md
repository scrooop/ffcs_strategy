---
name: Implement TastyTrade fallback for Yahoo Finance failures
status: open
created: 2025-10-19T23:56:22Z
updated: 2025-10-20T00:07:06Z
github: https://github.com/scrooop/ffcs_strategy/issues/17
depends_on: [15, 16]
parallel: false
conflicts_with: []
---

# Task: Implement TastyTrade fallback for Yahoo Finance failures

## Description

Add TastyTrade API as a fallback earnings data source when Yahoo Finance fails or returns no data. This ensures reliability even if Yahoo Finance API changes or experiences downtime. Implements the full fallback chain: Cache → Yahoo Finance → TastyTrade → Graceful degradation.

**Key responsibilities:**
- Add `_fetch_from_tastytrade()` method to `EarningsCache` class
- Modify `get_next_earnings()` to try Yahoo first, then TastyTrade
- Handle timeouts, errors, and missing data gracefully
- Log data source for debugging
- Pass TastyTrade session to cache for API calls

## Acceptance Criteria

- [ ] `_fetch_from_tastytrade(session, symbol)` method added to `EarningsCache` class
- [ ] Fallback chain implemented: Cache → Yahoo → TastyTrade → None (allow through with warning)
- [ ] `EarningsCache.__init__()` accepts optional `session` parameter for TastyTrade fallback
- [ ] Yahoo Finance timeout set to 5 seconds (prevents hanging)
- [ ] If Yahoo fails, try TastyTrade via `fetch_market_metrics()` call
- [ ] If TastyTrade fails, log warning and return None (allow symbol through)
- [ ] Data source tracked in returned dict: "cache" | "yahoo" | "tastytrade"
- [ ] Cache stores results from whichever source succeeds
- [ ] Error messages are clear and actionable (e.g., "Yahoo Finance timeout, trying TastyTrade...")

## Technical Details

**File location:** `scripts/earnings_cache.py`

**Modified class structure:**
```python
class EarningsCache:
    def __init__(self, cache_path: str = ".cache/earnings.db", session=None):
        """Initialize cache with optional TastyTrade session for fallback."""
        self.session = session  # For TastyTrade API calls
        # ... existing init code ...

    def get_next_earnings(self, symbol: str) -> dict:
        """Fetch earnings with fallback chain."""
        # 1. Check cache first
        cached = self._get_from_cache(symbol)
        if cached and self._is_cache_fresh(cached['next_earnings_date']):
            return {"symbol": symbol, "next_earnings": cached['next_earnings_date'],
                    "source": "cache", "cached_at": cached['last_updated']}

        # 2. Try Yahoo Finance
        try:
            yahoo_date = self._fetch_from_yahoo(symbol)
            if yahoo_date:
                self._save_to_cache(symbol, yahoo_date, "yahoo")
                return {"symbol": symbol, "next_earnings": yahoo_date,
                        "source": "yahoo", "cached_at": datetime.now(UTC).isoformat()}
        except Exception as e:
            print(f"[WARN] {symbol}: Yahoo Finance failed ({e}), trying TastyTrade...", file=sys.stderr)

        # 3. Try TastyTrade fallback
        if self.session:
            try:
                tt_date = self._fetch_from_tastytrade(self.session, symbol)
                if tt_date:
                    self._save_to_cache(symbol, tt_date, "tastytrade")
                    return {"symbol": symbol, "next_earnings": tt_date,
                            "source": "tastytrade", "cached_at": datetime.now(UTC).isoformat()}
            except Exception as e:
                print(f"[WARN] {symbol}: TastyTrade fallback failed ({e})", file=sys.stderr)

        # 4. Graceful degradation
        print(f"[WARN] {symbol}: No earnings data available (allow through)", file=sys.stderr)
        return {"symbol": symbol, "next_earnings": None, "source": "none", "cached_at": None}

    def _fetch_from_yahoo(self, symbol: str, timeout: int = 5) -> Optional[date]:
        """Fetch from Yahoo Finance with timeout."""
        # Set timeout on yfinance call
        # ... implementation ...

    def _fetch_from_tastytrade(self, session, symbol: str) -> Optional[date]:
        """Fetch from TastyTrade API as fallback."""
        # Call existing fetch_market_metrics() function
        # Extract earnings date from response
        # ... implementation ...
```

**TastyTrade integration:**
- Reuse existing `fetch_market_metrics()` function from scanner
- Extract `earnings.expected_report_date` from response
- Handle missing data gracefully (return None)

**Timeout handling:**
- Yahoo Finance: 5-second timeout
- TastyTrade: Use default (no additional timeout, already throttled)

**Files affected:**
- `scripts/earnings_cache.py` (modified EarningsCache class)
- `scripts/ff_tastytrade_scanner.py` (pass session to EarningsCache constructor)

## Dependencies

- [ ] Task 001 completed (EarningsCache module exists)
- [ ] Task 002 completed (Scanner integration in place)
- [ ] Existing `fetch_market_metrics()` function in scanner

## Effort Estimate

- **Size:** S (Small)
- **Hours:** 4-6 hours
- **Parallel:** false (depends on Tasks 001, 002)

**Breakdown:**
- Add session parameter to EarningsCache: 1 hour
- Implement _fetch_from_tastytrade(): 2 hours
- Add timeout to Yahoo Finance: 1 hour
- Error handling and logging: 1 hour
- Testing: 1-2 hours

## Definition of Done

- [ ] Code implemented with fallback chain
- [ ] Manual testing: Simulate Yahoo Finance failure (mock or network block)
- [ ] Manual testing: Verify TastyTrade fallback works
- [ ] Manual testing: Verify timeout prevents hanging
- [ ] Manual testing: Verify graceful degradation (no crash on total failure)
- [ ] Logging: Verify clear error messages in console
- [ ] Code reviewed (check error handling edge cases)

## Testing Notes

**Manual testing checklist:**
1. Normal case: Yahoo Finance works, verify fast response
2. Yahoo Finance timeout: Mock slow response, verify 5s timeout → TastyTrade fallback
3. Yahoo Finance error: Mock exception, verify TastyTrade fallback
4. Both fail: Verify graceful degradation (return None, log warning)
5. TastyTrade session not provided: Verify Yahoo-only mode works

**Fallback sequence testing:**
```python
# Test 1: Yahoo works
earnings = cache.get_next_earnings("AAPL")
assert earnings['source'] == 'yahoo'

# Test 2: Yahoo fails, TastyTrade works
# (mock Yahoo to raise exception)
earnings = cache.get_next_earnings("AAPL")
assert earnings['source'] == 'tastytrade'

# Test 3: Both fail
# (mock both to fail)
earnings = cache.get_next_earnings("AAPL")
assert earnings['next_earnings'] is None
assert earnings['source'] == 'none'
```

**Edge cases:**
- Session is None (TastyTrade fallback disabled)
- Symbol not found on either API
- Network timeout on both APIs
- Invalid date format returned from API

## Notes

**Yahoo Finance primary:** This task maintains Yahoo Finance as the PRIMARY source. TastyTrade is only used as a fallback (<1% of requests expected).

**Performance:** Fallback should not significantly impact performance. Most requests will still hit cache or Yahoo Finance (<100ms).

**Session management:** Scanner already creates TastyTrade session. Just pass it to EarningsCache constructor: `cache = EarningsCache(session=session)`.
