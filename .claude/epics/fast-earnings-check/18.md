---
name: Add earnings_source column to CSV output
status: open
created: 2025-10-19T23:56:22Z
updated: 2025-10-20T00:07:12Z
github: https://github.com/scrooop/ffcs_strategy/issues/18
depends_on: [16, 17]
parallel: true
conflicts_with: [19]
---

# Task: Add earnings_source column to CSV output

## Description

Extend the CSV output schema to include `earnings_source` column, tracking where earnings data came from ("cache", "yahoo", "tastytrade"). This provides transparency and debugging capability for users to understand data provenance.

**Key changes:**
- Add `earnings_source` to CSV schema (29th column)
- Populate from `earnings_data` dict returned by `EarningsCache`
- Update CSV header row
- Maintain backward compatibility (readers ignore unknown columns)

## Acceptance Criteria

- [ ] CSV schema extended from 28 to 29 columns
- [ ] New column: `earnings_source` (values: "cache" | "yahoo" | "tastytrade" | "none")
- [ ] CSV header row includes `earnings_source` in correct position
- [ ] Column populated with actual data source from `EarningsCache.batch_get_earnings()`
- [ ] If `--allow-earnings` flag used, earnings_source = "skipped"
- [ ] Backward compatibility: Existing CSV readers don't break (column appended at end)
- [ ] Updated CSV example in documentation shows new column

## Technical Details

**File location:** `scripts/ff_tastytrade_scanner.py`

**Current CSV schema (28 columns):**
```
timestamp, symbol, structure, call_ff, put_ff, combined_ff, spot_price,
front_dte, back_dte, front_expiry, back_expiry, atm_strike, call_strike,
put_strike, call_delta, put_delta, call_front_iv, call_back_iv, call_fwd_iv,
put_front_iv, put_back_iv, put_fwd_iv, earnings_conflict, earnings_date,
liquidity_rating, liquidity_value, iv_source_call_front, iv_source_call_back,
iv_source_put_front, iv_source_put_back
```

**New CSV schema (29 columns):**
```
...(same as above)..., earnings_source
```

**Implementation:**
1. Update CSV header row to include "earnings_source"
2. When writing CSV rows, append earnings_source value
3. Get earnings_source from earnings_data dict: `earnings_data[symbol]['source']`

**Example CSV row:**
```csv
2025-10-19T23:56:22+00:00,SPY,atm-call,0.25,0.24,0.245,450.00,30,60,2025-11-20,2025-12-20,450,,,,,0.20,0.18,0.17,0.20,0.18,0.17,no,,5,0.95,greeks,greeks,greeks,greeks,yahoo
```

**Files affected:**
- `scripts/ff_tastytrade_scanner.py` (CSV writing logic)

## Dependencies

- [ ] Task 002 completed (earnings_data dict available in main())
- [ ] Task 003 completed (earnings_source values populated)

## Effort Estimate

- **Size:** XS (Extra Small)
- **Hours:** 2-3 hours
- **Parallel:** true (independent CSV change, conflicts with Task 005 on same file)

**Breakdown:**
- Update CSV header: 30 minutes
- Update CSV row writing: 1 hour
- Testing with various scenarios: 1 hour
- Update documentation example: 30 minutes

## Definition of Done

- [ ] Code implemented in CSV writing logic
- [ ] Manual testing: Generate CSV with 10 symbols, verify earnings_source column present
- [ ] Manual testing: Verify values are correct (cache, yahoo, tastytrade)
- [ ] Manual testing: Load CSV in Excel/spreadsheet, verify no parsing errors
- [ ] Backward compatibility: Verify existing CSV readers still work
- [ ] Code reviewed

## Testing Notes

**Manual testing checklist:**
1. Run scanner with cache hits: Verify earnings_source = "cache"
2. Run scanner with cache misses: Verify earnings_source = "yahoo"
3. Simulate Yahoo failure: Verify earnings_source = "tastytrade"
4. Run scanner with --allow-earnings: Verify earnings_source = "skipped"
5. Load CSV in Excel: Verify column appears correctly

**CSV parsing test:**
```python
import csv
with open('scan.csv', 'r') as f:
    reader = csv.DictReader(f)
    for row in reader:
        assert 'earnings_source' in row
        assert row['earnings_source'] in ['cache', 'yahoo', 'tastytrade', 'skipped', 'none']
```

**Backward compatibility:**
- Old CSV readers that expect 28 columns will ignore the 29th column
- Readers using `csv.DictReader` will automatically pick up new column

## Notes

**Column position:** Append at end (29th column) to minimize disruption to existing tools that may rely on column order.

**Documentation update:** This task only updates the code. Task 006 will update documentation (README_TT.md, CLAUDE.md) to reflect new schema.

**Conflicts with Task 005:** Both tasks modify `ff_tastytrade_scanner.py`. Coordinate to avoid merge conflicts, or complete sequentially.
