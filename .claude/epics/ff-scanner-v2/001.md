---
name: Market Metrics Integration
status: completed
created: 2025-10-19T08:51:48Z
updated: 2025-10-19T15:10:00Z
github: https://github.com/scrooop/ffcs_strategy/issues/2
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Market Metrics Integration

## Description
Implement batched earnings and liquidity data fetching from tastytrade Market Metrics API. Add filtering functions to check earnings conflicts and liquidity thresholds before expensive Greeks streaming operations.

## Acceptance Criteria
- [x] `fetch_market_metrics()` function fetches data for all symbols in single API call
- [x] `check_earnings_conflict()` detects earnings between today and back expiry
- [x] `check_liquidity()` filters symbols below minimum liquidity rating threshold
- [x] CLI flags implemented: `--skip-earnings`, `--allow-earnings`, `--show-earnings-conflicts`, `--min-liquidity-rating`, `--skip-liquidity-check`
- [x] Warning messages logged when symbols are filtered
- [x] Integration with main scanning loop (pre-filter before Greeks streaming)

## Technical Details

**Implementation Approach:**
- Add `async def fetch_market_metrics(session: Session, symbols: List[str]) -> Dict[str, MarketMetricInfo]` function
- Use `tastytrade.metrics.get_market_metrics()` for batch request
- Add filter functions returning `(passes: bool, reason: Optional[str])` tuples
- Integrate into main loop before option chain fetching

**Files Affected:**
- `scripts/ff_tastytrade_scanner.py` - Add new functions and CLI flags
- Main scanning loop - Add pre-filtering logic

**Key Considerations:**
- Batch all symbols in single API call (minimize overhead)
- Handle missing data gracefully (log warning, don't crash)
- Validate earnings date exists and is not None
- Default behavior: skip earnings conflicts (safer for production)

## Dependencies
- [x] tastytrade SDK v10.1.0+ installed
- [x] Production tastytrade environment access
- [x] Valid TT_USERNAME and TT_PASSWORD credentials

## Effort Estimate
- Size: M
- Hours: 3-4 hours
- Parallel: true (independent of other tasks)

## Definition of Done
- [x] Code implemented with proper error handling
- [x] Function docstrings with type hints added
- [x] CLI flags functional and documented in --help
- [x] Manual testing: 10-symbol scan with earnings filtering works
- [x] Warning messages appear when symbols filtered
- [x] No crashes on missing/None data

## Implementation Summary

**Commits:**
- f68eb08 - Initial implementation (163 lines added)
- 97fd2df - Bug fix: correct API attribute path for earnings dates

**Bug Fix:** Initial implementation used wrong attribute path (`earnings_date`). Fixed to use `metric_info.earnings.expected_report_date`.

**Verification:** AAPL correctly filtered with "Earnings on 2025-10-30 conflicts with back expiry 2025-12-19"

**Status:** âœ… COMPLETE - All acceptance criteria met, bug fixed, tested and verified
