---
name: Market Metrics Integration
status: open
created: 2025-10-19T08:51:48Z
updated: 2025-10-19T08:51:48Z
github: [Will be updated when synced to GitHub]
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Market Metrics Integration

## Description
Implement batched earnings and liquidity data fetching from tastytrade Market Metrics API. Add filtering functions to check earnings conflicts and liquidity thresholds before expensive Greeks streaming operations.

## Acceptance Criteria
- [ ] `fetch_market_metrics()` function fetches data for all symbols in single API call
- [ ] `check_earnings_conflict()` detects earnings between today and back expiry
- [ ] `check_liquidity()` filters symbols below minimum liquidity rating threshold
- [ ] CLI flags implemented: `--skip-earnings`, `--allow-earnings`, `--show-earnings-conflicts`, `--min-liquidity-rating`, `--skip-liquidity-check`
- [ ] Warning messages logged when symbols are filtered
- [ ] Integration with main scanning loop (pre-filter before Greeks streaming)

## Technical Details

**Implementation Approach:**
- Add `async def fetch_market_metrics(session: Session, symbols: List[str]) -> Dict[str, MarketMetricInfo]` function
- Use `tastytrade.metrics.get_market_metrics()` for batch request
- Add filter functions returning `(passes: bool, reason: Optional[str])` tuples
- Integrate into main loop before option chain fetching

**Files Affected:**
- `scripts/ff_tastytrade_scanner.py` - Add new functions and CLI flags
- Main scanning loop - Add pre-filtering logic

**Key Considerations:**
- Batch all symbols in single API call (minimize overhead)
- Handle missing data gracefully (log warning, don't crash)
- Validate earnings date exists and is not None
- Default behavior: skip earnings conflicts (safer for production)

## Dependencies
- [ ] tastytrade SDK v10.1.0+ installed
- [ ] Production tastytrade environment access
- [ ] Valid TT_USERNAME and TT_PASSWORD credentials

## Effort Estimate
- Size: M
- Hours: 3-4 hours
- Parallel: true (independent of other tasks)

## Definition of Done
- [ ] Code implemented with proper error handling
- [ ] Function docstrings with type hints added
- [ ] CLI flags functional and documented in --help
- [ ] Manual testing: 10-symbol scan with earnings filtering works
- [ ] Warning messages appear when symbols filtered
- [ ] No crashes on missing/None data
