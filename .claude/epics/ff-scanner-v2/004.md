---
name: Double Calendar Scanning Logic
status: open
created: 2025-10-19T08:51:48Z
updated: 2025-10-19T08:51:48Z
github: [Will be updated when synced to GitHub]
depends_on: [002, 003]
parallel: false
conflicts_with: [002]
---

# Task: Double Calendar Scanning Logic

## Description
Implement structure-based scanning that supports ATM call calendars, double calendars (±35Δ call + put), or both. Compute separate Forward Factors for call and put calendars, calculate combined FF, and integrate into main scanning loop.

## Acceptance Criteria
- [ ] `scan_atm_calendar()` function extracts current ATM logic
- [ ] `scan_double_calendar()` function implements ±35Δ scanning
- [ ] CLI flag `--structure {atm-call,double,both}` implemented (default: both)
- [ ] Double calendar computes `call_ff`, `put_ff`, and `combined_ff` (arithmetic mean)
- [ ] Main loop calls appropriate scan function based on --structure flag
- [ ] Results include structure type in output
- [ ] `--min-ff` threshold applied to `combined_ff` for double calendars

## Technical Details

**Implementation Approach:**
- Refactor existing main loop logic into `scan_atm_calendar()` function
- Create `scan_double_calendar()` that:
  1. Calls `find_delta_strikes()` for front and back expirations
  2. Fetches Greeks for ±35Δ strikes
  3. Computes FF for call calendar (front +35Δ / back +35Δ)
  4. Computes FF for put calendar (front -35Δ / back -35Δ)
  5. Calculates `combined_ff = (call_ff + put_ff) / 2`
- Main loop switches based on `--structure` flag value

**Files Affected:**
- `scripts/ff_tastytrade_scanner.py` - Refactor main loop, add scan functions
- CLI argument parser - Add `--structure` flag

**Key Considerations:**
- Reuse existing FF calculation logic (variance decomposition)
- Handle case where double calendar strikes not found (skip or fall back to ATM)
- Each symbol can return 0-2 results (ATM + double when --structure=both)
- Preserve all metadata (strikes, deltas, individual FFs) for CSV output

## Dependencies
- [ ] Task 002 completed (enhanced Greeks)
- [ ] Task 003 completed (delta strike selection)

## Effort Estimate
- Size: M
- Hours: 3-4 hours
- Parallel: false (requires Tasks 002, 003)

## Definition of Done
- [ ] Code implemented with proper error handling
- [ ] Function docstrings with type hints
- [ ] `--structure` CLI flag functional
- [ ] Manual testing: SPY with --structure=both returns ATM + double results
- [ ] Combined FF calculated correctly (arithmetic mean)
- [ ] Threshold filtering works for both structures
