---
name: Implement Futures Options Support
status: completed
created: 2025-10-19T19:10:50Z
updated: 2025-10-19T21:30:00Z
completed: 2025-10-19T21:30:00Z
github: https://github.com/scrooop/ffcs_strategy/issues/13
depends_on: [12]
parallel: true
conflicts_with: []
---

# Task: Implement Futures Options Support

## Description

Add full futures options support to the FF scanner based on findings from Task 12 investigation. Implement the 4 identified code changes to enable scanning of futures symbols like /ES (E-mini S&P 500), /GC (Gold), /NQ (Nasdaq), and /CL (Crude Oil).

## Acceptance Criteria

- [x] Symbol type detection implemented (futures vs equity)
- [x] Spot price retrieval from Yahoo Finance (yfinance library)
- [x] Earnings filter automatically bypassed for futures symbols
- [x] CLI bug fixed: `--allow-earnings` flag now works correctly
- [x] Scanner successfully runs with futures symbols (/ES, /GC, /NQ, /CL)
- [x] CSV output works for futures with correct structure and data
- [x] Backward compatibility maintained (equity scanning still works)
- [x] Documentation updated with futures usage examples

## Technical Details

**Based on Task 12 Investigation Results:**
- tastytrade API fully supports futures options
- `NestedOptionChain.get()` already works with futures symbols
- No fundamental blockers - changes are isolated and low-risk
- Full backward compatibility can be maintained

### Code Change 1: Symbol Type Detection

**Location:** `scripts/ff_tastytrade_scanner.py` (near beginning of scan function)

**Implementation:**
```python
def is_futures_symbol(symbol: str) -> bool:
    """
    Check if symbol is a futures symbol.

    Futures symbols start with '/' (e.g., /ES, /GC, /NQ).
    Equity symbols do not (e.g., SPY, QQQ, AAPL).
    """
    return symbol.startswith('/')
```

**Usage:** Check symbol type before making API calls to determine appropriate handling

### Code Change 2: Spot Price Retrieval for Futures

**Problem:** `get_market_data()` with `/ES` fails because root symbol isn't tradeable

**Solution:** For futures, get spot price from the active (front-month) futures contract

**Location:** Where spot price is fetched (around line with `get_market_data()`)

**Implementation approach:**
```python
if is_futures_symbol(symbol):
    # Get active futures contract (front month)
    # Use NestedFutureOptionChain or Future API to find active contract
    # Extract spot price from active contract
    spot_price = get_futures_spot_price(session, symbol)
else:
    # Existing equity logic
    quote = get_market_data(session, symbol, InstrumentType.EQUITY)
    spot_price = quote.last
```

**Reference:** Task 12 findings document section "Required Code Changes"

### Code Change 3: Skip Earnings Filter for Futures

**Location:** Where earnings check occurs (around `check_earnings_conflict()` call)

**Implementation:**
```python
# Skip earnings check for futures (they don't have earnings)
if is_futures_symbol(symbol):
    earnings_conflict = False
    earnings_date = None
else:
    # Existing earnings check logic
    passes, reason = check_earnings_conflict(...)
    earnings_conflict = not passes
```

**Rationale:** Futures contracts don't have earnings announcements

### Code Change 4: Fix CLI Bug - `--allow-earnings` Flag

**Problem:** `--allow-earnings` flag doesn't work due to conflicting argparse defaults

**Location:** `scripts/ff_tastytrade_scanner.py` - argparse setup (around line 700-750)

**Current (broken) code:**
```python
parser.add_argument('--skip-earnings', action='store_true', default=True, ...)
parser.add_argument('--allow-earnings', action='store_true', ...)
```

**Fixed code:**
```python
earnings_group = parser.add_mutually_exclusive_group()
earnings_group.add_argument('--skip-earnings', action='store_true', default=True,
    help='Skip positions with earnings conflicts (default)')
earnings_group.add_argument('--allow-earnings', action='store_true',
    help='Allow trading through earnings (disable earnings filtering)')
```

**Reference:** Task 12 findings - "Bonus Discovery: CLI Bug"

### Testing Requirements

**Test 1: Futures Symbols Work**
```bash
python scripts/ff_tastytrade_scanner.py \
  --tickers /ES /GC \
  --pairs 30-60 \
  --min-ff 0.20 \
  --csv-out futures_test.csv
```
Expected: CSV output with futures results, no errors

**Test 2: Equity Symbols Still Work (Backward Compatibility)**
```bash
python scripts/ff_tastytrade_scanner.py \
  --tickers SPY QQQ \
  --pairs 30-60 \
  --min-ff 0.20 \
  --csv-out equity_test.csv
```
Expected: Same behavior as v2.0

**Test 3: Mixed Equity and Futures**
```bash
python scripts/ff_tastytrade_scanner.py \
  --tickers SPY /ES QQQ /GC \
  --pairs 30-60 \
  --min-ff 0.20 \
  --csv-out mixed_test.csv
```
Expected: Both asset types in CSV output

**Test 4: CLI Bug Fix**
```bash
python scripts/ff_tastytrade_scanner.py \
  --tickers AAPL \
  --pairs 30-90 \
  --allow-earnings \
  --csv-out earnings_override_test.csv
```
Expected: Earnings filter disabled, AAPL scanned even with earnings

## Implementation Strategy

**Phase 1: Add Helper Functions (30 min)**
1. Create `is_futures_symbol()` function
2. Create `get_futures_spot_price()` function
3. Add unit tests for symbol detection

**Phase 2: Fix CLI Bug (30 min)**
1. Change argparse to use mutually exclusive group
2. Test `--allow-earnings` and `--skip-earnings` flags
3. Verify default behavior unchanged

**Phase 3: Integrate Futures Support (1-2 hours)**
1. Add symbol type detection in scan loop
2. Branch spot price retrieval based on symbol type
3. Skip earnings check for futures symbols
4. Test with /ES and /GC

**Phase 4: Testing & Validation (1 hour)**
1. Run all 4 test scenarios above
2. Compare futures CSV output with equity baseline
3. Verify Greeks, IV, and FF calculations look correct
4. Fix any edge cases discovered

**Phase 5: Documentation (30 min)**
1. Update CLAUDE.md with futures support status
2. Update README_TT.md with futures examples
3. Add futures symbols to Quick Start guide
4. Document known limitations (if any)

## Dependencies

- [x] Task 12 completed (investigation findings available)
- [ ] Access to tastytrade production account with futures permissions
- [ ] Futures options trading approval (may differ from equity options)

## Files to Modify

- `scripts/ff_tastytrade_scanner.py` - Main scanner logic (4 changes)
- `CLAUDE.md` - Add futures support documentation
- `scripts/README_TT.md` - Add futures usage examples

## Effort Estimate

- Size: M
- Hours: 3-5 hours
  - Code changes: 2-3 hours
  - Testing: 1-2 hours
  - Documentation: 30 min
- Parallel: true (independent of other tasks)

## Definition of Done

- [x] All 4 code changes implemented
- [x] Scanner runs successfully with /ES and /GC
- [x] Equity scanning still works (backward compatibility)
- [x] Mixed equity/futures scans work
- [x] `--allow-earnings` flag fixed and working
- [x] CSV output correct for futures symbols
- [x] Error handling added for missing market data
- [x] Documentation updated with futures examples
- [x] Code committed to git

## Completion Summary

**Status:** âœ… COMPLETED on 2025-10-19

**Implementation Results:**
- 8 verified working futures: /ES, /NQ, /RTY, /GC, /CL, /MES, /MNQ, /MCL
- Equity backward compatibility verified (SPY, QQQ)
- All 4 planned code changes completed
- 2 bonus fixes: crash on missing market data, Python 3.14 datetime warning

**Git Commit:** d62038b
**Files Modified:** 4 (scanner, CLAUDE.md, SOP.md, README_TT.md)
**Lines Changed:** +312, -89

**Testing Evidence:**
- futures_test.csv: /ES scanning with ATM + double calendars
- equity_backward_compat_test.csv: SPY/QQQ verification
- futures_test_results.txt: Complete 28-symbol test matrix

## Reference Materials

- **Investigation findings:** `.claude/epics/ff-scanner-v2/updates/12/findings.md`
- **Test script:** `test_futures_api.py` (reference for API usage)
- **Task 12:** `.claude/epics/ff-scanner-v2/12.md`

## Known Limitations

Based on Task 12 investigation:
- Liquidity metrics for futures may differ from equities (needs testing)
- Greeks availability for futures options not yet verified (test during implementation)
- May need to handle futures expiration cycles differently than equity options
- Futures symbols must include `/` prefix (e.g., `/ES` not `ES`)

## Success Metrics

- Futures symbols scan without errors
- FF calculations produce reasonable values (similar to equity ranges)
- CSV output follows same 25-column schema
- No regression in equity scanning performance or accuracy
