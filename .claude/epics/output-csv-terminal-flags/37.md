---
name: Fix High-Volume Scanning Crash (Pydantic Error)
status: open
created: 2025-10-20T17:48:36Z
updated: 2025-10-20T18:23:15Z
github: https://github.com/scrooop/ffcs_strategy/issues/37
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Fix High-Volume Scanning Crash (Pydantic Error)

## Description

Wrap `NestedOptionChain.get()` and `NestedFutureOptionChain.get()` in try/except blocks to handle Pydantic ValidationErrors when tastytrade API returns expirations without 'strikes' field. This fix enables scanning 1500+ symbols without crashes, eliminating need for manual symbol list batching.

**Priority:** HIGH (Phase 2)

**Current Error:**
```
pydantic_core._pydantic_core.ValidationError: 1 validation error for NestedOptionChain
expirations.1.strikes
  Field required [type=missing, input_value={'expiration-type': 'Regu...'settlement-type': 'PM'}, input_type=dict]
```

## Acceptance Criteria

- [ ] `NestedOptionChain.get()` wrapped in try/except for Pydantic ValidationError
- [ ] `NestedFutureOptionChain.get()` wrapped in try/except for Pydantic ValidationError
- [ ] `SKIP_INVALID_CHAIN` constant added to skip reasons
- [ ] Skip stats tracking updated for invalid chain errors
- [ ] Clear warning logged when symbol skipped due to invalid chain
- [ ] 1500+ symbol scan completes without crashes (S&P 1500 test)
- [ ] `skip_reason` CSV column populated with "invalid_chain_data"

## Technical Details

### Files to Modify
- `scripts/ff_tastytrade_scanner.py`:
  - Add constant (around line 50-62): `SKIP_INVALID_CHAIN = "invalid_chain_data"`
  - Wrap chain fetch logic (around line 1115-1125)
  - Update skip_stats tracking

### Implementation Approach

**1. Add Skip Reason Constant:**
```python
# At top of file with other skip reason constants (line 50-62)
SKIP_INVALID_CHAIN = "invalid_chain_data"
```

**2. Wrap NestedOptionChain.get():**
```python
# Around line 1119 in scan() function
try:
    if is_futures:
        chain_list = NestedFutureOptionChain.get(session, sym)
    else:
        chain_list = NestedOptionChain.get(session, sym)
except pydantic.ValidationError as e:
    logger.warning(f"{sym}: Invalid option chain data (Pydantic validation failed: {e}), skipping")
    skip_stats[SKIP_INVALID_CHAIN] = skip_stats.get(SKIP_INVALID_CHAIN, 0) + 1
    continue  # Skip to next symbol
except Exception as e:
    logger.error(f"{sym}: Failed to fetch option chain ({type(e).__name__}: {e}), skipping")
    skip_stats[SKIP_NO_CHAIN] = skip_stats.get(SKIP_NO_CHAIN, 0) + 1
    continue
```

**3. Ensure Import:**
```python
# Verify pydantic is imported at top of file (should already be via tastytrade)
import pydantic
```

### Key Considerations
- Catch `pydantic.ValidationError` specifically (not generic `Exception`)
- Log symbol and brief error message (not full traceback)
- Continue to next symbol (don't crash entire scan)
- Update skip_stats for tracking/reporting
- Handle both equities (`NestedOptionChain`) and futures (`NestedFutureOptionChain`)

### Testing Strategy
- Create test symbol list with known problematic symbols (if available)
- Test with S&P 1500 index (1500 symbols)
- Verify skip_stats shows count of invalid_chain_data skips
- Check CSV includes skip_reason = "invalid_chain_data" for affected symbols

## Dependencies

**External:**
- [ ] tastytrade SDK installed (`tastytrade>=7.0`)
- [ ] pydantic available (via tastytrade dependency)

**Internal:**
- [ ] No dependencies (can implement immediately)

## Effort Estimate

- **Size:** XS (Extra Small)
- **Hours:** 2-3 hours
- **Parallel:** true (no conflicts with other tasks)

### Breakdown:
- Add constant & update skip logic: 0.5 hour
- Implement try/except wrapper: 0.5 hour
- Testing with large symbol list: 1-2 hours

## Definition of Done

- [ ] Code implemented in `ff_tastytrade_scanner.py`
- [ ] Tested with 1500+ symbol list (S&P 1500 or Russell 2000)
- [ ] Scan completes without crashes (100% success rate)
- [ ] Skip stats show invalid_chain_data count
- [ ] CSV output includes skip_reason for skipped symbols
- [ ] Logger warning shows symbol and error type (not full traceback)
- [ ] Both equity and futures option chains handled
